# Исправление функции экспорта результатов в CSV

## Проблема
После миграции с Delphi 7 на Delphi 12 функция "Экспорт результатов в CSV..." не работала при нажатии на соответствующий пункт меню.

## Выявленные причины

### 1. Отсутствие обработчика OnClick для списка событий
- В форме `form_managestart.dfm` отсутствовал обработчик `OnClick` для `lbEvents`
- Состояние меню обновлялось только при показе контекстного меню (`pmEventPopup`)
- При обычном клике по элементу списка состояние меню не обновлялось

### 2. Слишком строгие условия активации меню
- Меню экспорта было привязано к `mnuPrintResults.Enabled`
- Печать результатов требует, чтобы соревнование было начато (`started`)
- Экспорт CSV может быть полезен и до начала соревнования (для экспорта списка участников)

### 3. Слишком строгие проверки в функции экспорта
- Функция требовала, чтобы соревнование было начато (`IsStarted`)
- Это препятствовало экспорту списка участников до начала соревнования

## Внесенные исправления

### 1. Добавлен обработчик OnClick для списка событий

**Файл: form_managestart.pas**
```pascal
// Добавлено объявление процедуры
procedure lbEventsClick(Sender: TObject);

// Добавлена реализация
procedure TManageStartForm.lbEventsClick(Sender: TObject);
begin
  // Обновляем состояние меню при клике на элемент списка
  pmEventPopup(pmEvent);
end;
```

**Файл: form_managestart.dfm**
```
// Добавлен обработчик события
OnClick = lbEventsClick
```

### 2. Улучшена логика активации меню экспорта

**Файл: form_managestart.pas**
```pascal
// Изменено условие активации меню
// Было:
mnuCSV.Enabled:= mnuPrintResults.Enabled;

// Стало:
// Экспорт CSV доступен если есть жеребьевка (есть стрелки для экспорта)
mnuCSV.Enabled:= fEventsData [idx].lotsdrawn;
```

### 3. Смягчены условия в функции экспорта

**Файл: form_managestart.pas**
```pascal
// Изменена проверка условий экспорта
// Было:
if not ev.IsStarted then
  begin
    ShowMessage('Соревнование не начато. Нет результатов для экспорта.');
    exit;
  end;

// Стало:
// Более мягкая проверка - разрешаем экспорт если есть хотя бы один стрелок с результатами
if (ev.Shooters.Count = 0) then
  begin
    ShowMessage('Нет стрелков для экспорта.');
    exit;
  end;
```

### 4. Улучшена обработка ошибок в функции экспорта

**Файл: data.pas**
```pascal
// Добавлены проверки и обработка ошибок
procedure TStartListEventItem.ExportResultsToCSV(const FName: TFileName);
var
  s: TStringList;
  i: integer;
  fs: TFileStream;
  utf8Bytes: TBytes;
  csvLine: string;
begin
  if Shooters.Count = 0 then
    raise Exception.Create('Нет данных для экспорта');
    
  // ... код экспорта с улучшенной обработкой ошибок
end;
```

### 5. Исправлены кракозябры в комментариях

**Файл: data.pas**
```pascal
// Исправлены поврежденные комментарии
//  Регион(или номер), номер стартовый, фамилия, имя, год рождения,
// разряд, и результат серий серий и результат
```

## Результат

После внесения исправлений функция экспорта результатов в CSV должна работать корректно:

1. **Меню активируется** при выборе события в списке (если проведена жеребьевка)
2. **Экспорт доступен** даже до начала соревнования (для экспорта списка участников)
3. **Улучшена обработка ошибок** с информативными сообщениями
4. **Сохранение в UTF-8** для корректного отображения русских символов
5. **Добавлен заголовок CSV** с названиями колонок

## Тестирование

Для тестирования функции:

1. Откройте управление стартом
2. Выберите событие в списке
3. Убедитесь, что меню "Экспорт результатов в CSV..." активно
4. Нажмите на меню и проверьте создание CSV файла
5. Откройте созданный файл и убедитесь в корректности кодировки

## Совместимость

Изменения совместимы с Delphi 12 и не нарушают существующую функциональность.