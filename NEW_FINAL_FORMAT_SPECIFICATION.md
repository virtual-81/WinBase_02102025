# Техническое задание: Новый формат финала для ВП-60 и ПП-60

## Описание задачи

Реализовать новый формат финальной части для упражнений ВП-60 (воздушная винтовка) и ПП-60 (пневматический пистолет) согласно современным правилам стрельбы.

## Требования

### 1. Условия активации нового формата
- Упражнение: ВП-60 или ПП-60
- Установлен флажок "Финал" в настройках события
- Количество финалистов: 8 участников

### 2. Структура нового финала

#### Этап 1: "Стадия выбывания"
- **Участники**: 8 финалистов
- **Формат**: 5 серий по 5 выстрелов каждая
- **Система выбывания**:
  - После 3-й серии: выбывают 2 участника (7-8 места)
  - После 4-й серии: выбывают 2 участника (5-6 места)  
  - После 5-й серии: выбывают 2 участника (3-4 места)
  - Остаются 2 лидера для "Матча за золотую медаль"

#### Этап 2: "Матч за золотую медаль"
- **Участники**: 2 лидера из стадии выбывания
- **Формат**: Серии до достижения 16 очков с отрывом минимум в 2 очка
- **Система очков**:
  - Лучший выстрел: 2 очка
  - Равенство: 1 очко каждому
  - Проигрыш: 0 очков
- **Условие победы**: 16 очков с обязательным отрывом в 2 очка

### 3. Технические требования

#### Хранение данных
- **Серии**: Хранить как серии из 5 выстрелов
- **Точность**: С десятыми долями (0.0 - 54.5 для ПП, 0.0 - 54.5 для ВП)
- **Совместимость**: Сохранить структуру "старых финалов" для совместимости

#### Интерфейс ввода результатов
- **Стадия выбывания**: Ввод серий по 5 выстрелов
- **Матч за золото**: Ввод реальных серий с автоматическим начислением очков
- **Визуализация выбывания**: Отсутствие следующих серий у выбывших участников

#### Печать протоколов
- **Заголовки**: 
  - "Стадия выбывания" 
  - "Матч за золотую медаль"
- **Замена**: Слово "Финал" вместо "Квалификация" на странице финала

## Архитектурные решения

### 1. Определение типа финала
```pascal
function IsNewFinalFormat(Event: TEventItem): boolean;
begin
  Result := (Event.FinalPlaces > 0) and 
            (Event.HasFinal) and
            ((Event.ShortName = 'ВП-60') or (Event.ShortName = 'ПП-60'));
end;
```

### 2. Структура данных
- Добавить поле `fNewFinalFormat: boolean` в `TStartListEventItem`
- Расширить структуру хранения финальных результатов
- Добавить поля для хранения очков матча за золото

### 3. Формы ввода
- Модифицировать форму ввода результатов финала
- Добавить специальную логику для нового формата
- Реализовать автоматическое начисление очков

### 4. Печать
- Создать новые шаблоны протоколов
- Добавить логику определения формата при печати
- Реализовать отображение двух этапов

## Этапы реализации

### Этап 1: Базовая структура
1. Добавить поля в классы данных
2. Реализовать определение нового формата
3. Добавить сохранение/загрузку новых полей

### Этап 2: Интерфейс ввода
1. Модифицировать форму финала
2. Добавить логику стадии выбывания
3. Реализовать матч за золото

### Этап 3: Печать и отчеты
1. Создать новые шаблоны печати
2. Добавить экспорт в новом формате
3. Обновить существующие отчеты

### Этап 4: Тестирование
1. Создать тестовые данные
2. Проверить все сценарии
3. Валидация совместимости

## Файлы для модификации

### Основные классы данных
- `data.pas` - добавить поля и методы
- `form_final.pas` - модифицировать форму финала
- `print_results.pas` - обновить печать

### Формы интерфейса
- `form_relaysetup.pas` - настройки финала
- `form_managestart.pas` - управление событиями
- `form_printprotocol.pas` - печать протоколов

### Языковые ресурсы
- `russian.wbl` - добавить новые строки
- `english.wbl` - добавить переводы

## Совместимость

- Старый формат финалов остается без изменений
- Новый формат активируется только для ВП-60/ПП-60 с флагом "Финал"
- Файлы данных остаются совместимыми с предыдущими версиями